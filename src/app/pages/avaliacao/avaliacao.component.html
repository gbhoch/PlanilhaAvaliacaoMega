<div class="container-lg">
  <dx-data-grid
    id="dataGrid"
    (onCellDblClick)="onCellDblClick($event)"
    [dataSource]="setoresList"
    [rowAlternationEnabled]="true"
    [showRowLines]="true"
    [showBorders]="true"
    width="100%"
    height="100%"
  >
    <dxo-toolbar class="toolbar" id="toolbar">
      <dxi-item location="before" id="itemTitulo">
        PLANILHAS DE AVALIAÇÃO
      </dxi-item>
      <dxi-item>
        <!-- <dx-button
          icon="add"
          class="btn-criar"
          (click)="openPlanilhas()"
          [height]="35"
          [width]="35"
        ></dx-button> -->
      </dxi-item>
    </dxo-toolbar>

    <dxi-column alignment="center" dataField="nome" caption="Lista de Setores">
    </dxi-column>
    <ng-template #nomeTemplate let-data>
      <span class="cursor-pointer" (click)="abrirDrawerSetor(data)">
        {{ data.nome }}
      </span>
    </ng-template>
  </dx-data-grid>
</div>

<!-- Drawer -->
<div class="drawer" [class.open]="drawerAberto">
  <div class="drawer-header">
    <h3>Configuração de Planilha</h3>
    <button class="header-btn-cancelar" (click)="drawerAberto = false">
      X
    </button>
  </div>

  <div class="drawer-top">
    <!-- DATA-GRID lista de agrupadores -->
    <div class="agrupador-header">
      <dx-data-grid
        id="gridContainer"
        [rowAlternationEnabled]="true"
        [columnAutoWidth]="true"
        [dataSource]="agrupadoresList"
        width="100%"
        height="100%"
        [showBorders]="true"
      >
        <dxo-row-dragging
          [allowReordering]="true"
          [showDragIcons]="true"
          [onReorder]= "agrupadoresReorderHandler"
        ></dxo-row-dragging>

        <dxi-column
          caption="#"
          [width]="50"
          cellTemplate="agrupadorIndexTemplate"
          [visibleIndex]="0"
        ></dxi-column>
        <div *dxTemplate="let data of 'agrupadorIndexTemplate'">
          {{ getAgrupadorIndex(data.data) }}
        </div>

        <dxi-column
          caption="Agrupadores"
          dataField="nome"
          [allowGrouping]="false"
          [allowSorting]="true"
          [width]="'100%'"
          cellTemplate="agrupadorTemplate"
          [visibleIndex]="1"
        >
        </dxi-column>

        <dxo-master-detail
          [enabled]="true"
          template="detailTemplate"
        ></dxo-master-detail>

        <div *dxTemplate="let data of 'detailTemplate'">
          <dx-data-grid
            [dataSource]="agrupadoresSelecionados[data.data.nome] || []"
            [keyExpr]="'id'"
            [showBorders]="true"
            [columnAutoWidth]="true"
            [rowAlternationEnabled]="true"
            [showRowLines]="true"
          >
            <dxo-row-dragging
              [allowReordering]="true"
              [onReorder]="getItemReorderHandler(data.data.nome)"
              [showDragIcons]="true"
            ></dxo-row-dragging>

            <dxi-column
              caption="#"
              [width]="50"
              cellTemplate="itemIndexTemplate"
              [visibleIndex]="0"
            ></dxi-column>
            <div *dxTemplate="let itemData of 'itemIndexTemplate'">
              {{ getItemIndex(data.data.nome, itemData.data) }}  <!-- Verifiicar se 'itemData.data' é com '' ou sem -->
            </div>

            <dxi-column
              dataField="descricao"
              caption="Item Selecionado"
              [visibleIndex]="1"
            ></dxi-column>

            <dxi-column
              caption="Remover"
              [width]="75"
              cellTemplate="removerTemplate"
            ></dxi-column>

            <!-- <dxi-column
              type="buttons"
              caption="Remover"
              [buttons]="botaoRemover"
            ></dxi-column> -->
            <div *dxTemplate="let itemData of 'removerTemplate'">
              <dx-button
                icon="trash"
                hint="Remover item"
                (onClick)="
                  itemSelecionadoExcluir = itemData.data;
                  agrupadorAtual = data.data.nome;
                  popUpExcluirItem = true;
                "
                style="margin-left: 14px;"
              ></dx-button>
            </div>
          </dx-data-grid>
        </div>

        <div *dxTemplate="let data of 'agrupadorTemplate'">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              height: 100%;
              width: 100%;
            "
          >
            <span> {{ data.data.nome }} </span>

            <dx-button
              icon="plus"
              hint="Adicionar Itens"
              (onClick)="abrirSelecaoItens(data.data.nome)"
              type="default"
              style="margin-left: 10px"
            ></dx-button>
          </div>
        </div>

        <!-- <dxo-grouping #expand [autoExpandAll]="false"></dxo-grouping> -->
      </dx-data-grid>
    </div>

    <!-- Popup para selecionar itens -->
    <dx-popup
      [(visible)]="popupVisivel"
      width="50%"
      height="60%"
      [dragEnabled]="false"
      title="Selecionar Itens"
    >
      <div
        class="popup-wrapper"
        *dxTemplate="let data of 'content'"
        style="height: 100%; display: flex; flex-direction: column"
      >
        <div class="popup-scrollable">
          <dx-list
            [dataSource]="itensSelecionaveis"
            [displayExpr]="'descricao'"
            [selectionMode]="'multiple'"
            [(selectedItems)]="itensSelecionadosTemp"
            [showSelectionControls]="true"
          ></dx-list>
        </div>

        <div class="popup-footer">
          <button class="btn-confirmar" (click)="confirmarSelecaoItens()">
            Confirmar
          </button>
          <button class="btn-cancelar" (click)="cancelarAlteracoesItens()">
            Cancelar
          </button>
        </div>
      </div>
    </dx-popup>

    <!-- PopUp para Confirmar exclusão de Itens -->
    <dx-popup
      [(visible)]="popUpExcluirItem"
      [showTitle]="true"
      title="Confirmar Exclusão"
      [width]="400"
      [height]="200"
      [dragEnabled]="false"
      [showCloseButton]="true"
    >
      <div class="popup-content">
        <p>Tem certeza que deseja excluir este item?</p>
        <div class="popup-actions">
          <button class="btn-confirmar" (click)="confirmarExclusao()">
            Confirmar
          </button>
          <button class="btn-cancelar" (click)="fecharPopup()">Cancelar</button>
        </div>
      </div>
    </dx-popup>
  </div>

  <!-- Botão de salvar alterações -->
  <div class="drawer-footer" style="gap: 15px">
    <button class="btn-confirmar" (click)="salvarAlteracoes()">
      Salvar Alterações
    </button>

    <button class="btn-cancelar" (click)="cancelarAlteracoes()">
      Cancelar
    </button>
  </div>
</div>
